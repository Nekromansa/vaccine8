package buckets

import (
	"fmt"
	"log"
	"time"

	"github.com/coreos/bbolt"
	"github.com/timshannon/bolthold"

	"vaccine8/config"
)

//Profiles ...
type Profiles struct {
	ID, UserID uint64
	Workflow   string
	Createdate,
	Updatedate time.Time
	Dob time.Time

	IsDependent bool

	Code, Email, Mobile, Fullname,
	Title, Firstname, Lastname,
	Othername, Gender, MaritalStatus,
	Street, City, State, Country,
	StateOfOrigin, LocalGovtArea,

	Image, Relationship,
	Description string
}

func (profile Profiles) bucketName() string {
	return "Profiles"
}

//Create ...
func (profile Profiles) Create(bucketType *Profiles) (err error) {

	if err = config.Get().BoltHold.Bolt().Update(func(tx *bolt.Tx) error {

		if bucketType.Createdate.IsZero() {
			bucketType.Createdate = time.Now()
			bucketType.Updatedate = bucketType.Createdate
		}

		if bucketType.ID == 0 {
			bucket := tx.Bucket([]byte(profile.bucketName()))
			bucketType.ID, _ = bucket.NextSequence()
			bucketType.Createdate = time.Now()
		} else {
			bucketType.Updatedate = time.Now()
		}

		err = config.Get().BoltHold.TxUpsert(tx, bucketType.ID, bucketType)
		return err
	}); err != nil {
		log.Printf(err.Error())
	}
	return
}

//List ...
func (profile Profiles) List() (resultsALL []string) {
	var results []Profiles

	if err := config.Get().BoltHold.Bolt().View(func(tx *bolt.Tx) error {
		err := config.Get().BoltHold.Find(&results, bolthold.Where("ID").Gt(uint64(0)))
		return err
	}); err != nil {
		log.Printf(err.Error())
	} else {
		for _, record := range results {
			resultsALL = append(resultsALL, fmt.Sprintf("%+v", record))
		}
	}
	return
}

//GetFieldValue ...
func (profile Profiles) GetFieldValue(Field string, Value interface{}) (results []Profiles, err error) {

	if len(Field) > 0 {
		if err = config.Get().BoltHold.Bolt().View(func(tx *bolt.Tx) error {
			err = config.Get().BoltHold.Find(&results, bolthold.Where(Field).Eq(Value).SortBy("ID").Reverse())
			return err
		}); err != nil {
			log.Printf(err.Error())
		}
	}
	return
}
